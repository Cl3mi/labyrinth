name: CI - Build, Test & Metrics

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '25'

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build and install Contracts module
        run: mvn -B clean install
        working-directory: Labyrinth.Contracts

      - name: Build and install ManagementClient module
        run: mvn -B clean install
        working-directory: Labyrinth.ManagementClient

      - name: Build and test Server module
        run: mvn -B clean test
        working-directory: Labyrinth.Server

      - name: Build and test Client module with coverage
        run: mvn -B clean test jacoco:report
        working-directory: Labyrinth.Client

      - name: Generate Client Coverage Summary
        run: |
          echo "## Client Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if JaCoCo report exists
          if [ -f "Labyrinth.Client/target/site/jacoco/jacoco.csv" ]; then
            # Parse coverage from CSV
            echo "| Package | Class Coverage | Line Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|----------------|---------------|" >> $GITHUB_STEP_SUMMARY

            # Skip header and summarize by package
            tail -n +2 Labyrinth.Client/target/site/jacoco/jacoco.csv | \
            awk -F',' '{
              pkg=$1;
              missed_lines+=$8;
              covered_lines+=$9;
            }
            END {
              if (missed_lines + covered_lines > 0) {
                line_cov = (covered_lines * 100) / (missed_lines + covered_lines);
                printf "| Total | - | %.1f%% |\n", line_cov;
              }
            }' >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Full report available in artifacts." >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not generated." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Client Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: client-coverage-report
          path: Labyrinth.Client/target/site/jacoco/
          retention-days: 7

      - name: Count Java lines of code
        run: |
          echo "## Java Lines of Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count lines per module
          for module in Labyrinth.Server Labyrinth.Client; do
            if [ -d "$module/src" ]; then
              lines=$(find "$module/src" -name "*.java" -exec cat {} + 2>/dev/null | wc -l)
              echo "| $module | $lines |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Count total lines (Server + Client only)
          total=$(find Labyrinth.Server/src Labyrinth.Client/src -name "*.java" -exec cat {} + 2>/dev/null | wc -l)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Java lines: $total**" >> $GITHUB_STEP_SUMMARY

          # Also print to console
          echo "========================================"
          echo "  JAVA LINES OF CODE SUMMARY"
          echo "========================================"
          for module in Labyrinth.Server Labyrinth.Client; do
            if [ -d "$module/src" ]; then
              lines=$(find "$module/src" -name "*.java" -exec cat {} + 2>/dev/null | wc -l)
              printf "  %-25s %6d lines\n" "$module:" "$lines"
            fi
          done
          echo "----------------------------------------"
          printf "  %-25s %6d lines\n" "TOTAL:" "$total"
          echo "========================================"
